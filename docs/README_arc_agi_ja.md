# ARC-AGI 評価ガイド（Nejumi LLM Leaderboard 4 版）

**TL;DR**

ARC-AGI (Abstraction and Reasoning Corpus - Artificial General Intelligence) は、LLMの抽象的なパターンを理解し適用する能力を評価する視覚的推論ベンチマークです。Nejumi Leaderboardでは**ARC-AGI-1とARC-AGI-2の両方**を評価し、以下の特徴で運用しています：

🚀 **視覚的パターン認識**: モデルはトレーニング例から抽象的なパターンを特定し、テスト入力に適用する必要があります

📊 **評価範囲**: ARC-AGI-1（オリジナル）とARC-AGI-2（拡張）の両方のデータセットを評価し、最終リーダーボードではスコアを平均化

⚙️ **設定方法**: モデルconfigに`arc_agi`設定を指定するだけで、リトライ回数とエラーハンドリングをカスタマイズ可能

---

## 1. ARC-AGI とは

**ARC-AGI (Abstraction and Reasoning Corpus - Artificial General Intelligence)** は、AIシステムの抽象的なパターンを理解し適用する能力を評価するために設計されたベンチマークです。モデルは以下の視覚的パズルに取り組む必要があります：

1. **トレーニング例の分析**: 入出力ペアを研究して基本的なパターンを特定
2. **パターンの適用**: 発見したパターンを使用して新しいテスト入力の正しい出力を生成
3. **抽象化の処理**: 記憶された解決策ではなく、抽象的な視覚的概念で作業

### ARC-AGIのバージョン進化

| バージョン | 主要特徴 | 評価の焦点 |
|-----------|----------|-----------|
| **ARC-AGI-1** | オリジナルの視覚的推論タスク | 基本的なパターン認識と適用 |
| **ARC-AGI-2** ⭐ | 改善されたパターンを持つ拡張データセット | より複雑な視覚的推論と抽象化 |

⭐ **現在使用**: Nejumi Leaderboardでは両バージョンを評価し、スコアを平均化

### 評価対象と評価軸

ARC-AGIは以下の認知能力を評価します：

#### 🎯 **視覚的パターン認識**
- **パターン特定**: トレーニング例で繰り返し出現する視覚的パターンを認識する能力
- **抽象化**: 単純な視覚的類似性を超えた抽象的概念の理解
- **一般化**: 学習したパターンを新しい、未見の入力に適用

#### 🧠 **推論と問題解決**
- **帰納的推論**: 特定の例から一般的なルールを導き出す
- **空間的推論**: 空間的関係と変換の理解
- **論理的一貫性**: パターン適用における一貫性の維持

#### 🔄 **出力生成**
- **構造化された出力**: 正しい形式で有効なグリッドベースの出力を生成
- **パターン一貫性**: 出力が特定されたパターンに従うことを確保
- **形式準拠**: 必要なJSON配列形式への準拠

### 参考リンク

- 📊 **[ARC-AGI Benchmark](https://github.com/arcprize/arc-agi-benchmarking)**: 公式リポジトリと評価フレームワーク
- 📝 **[ARC-AGI Paper](https://arxiv.org/abs/2401.13720)**: ベンチマーク設計を説明する研究論文

---

## 2. 日本語評価データセットの作り方

ARC-AGI評価データセットは、計算効率を維持しながら代表的なパフォーマンス測定を確保するためのサンプリングロジックを使用して作成されます。

### データセット作成プロセス

#### **ベースデータセット**
- **ソース**: オリジナルのARC-AGI-1とARC-AGI-2評価データセット
- **形式**: トレーニング例とテストケースを含むJSONファイル
- **構造**: 各タスクには複数のトレーニング入出力ペアとテスト入力が含まれます

#### **サンプリング戦略**
- **リファレンスモデル**: ベースラインパフォーマンス測定にOpenAI o3 (medium)を使用
- **サンプリングパラメータ**: 一貫性のためにスクリプトのデフォルトパラメータを使用
  - `num_samples`: 50（デフォルト）
  - `seed`: 42（デフォルト）
  - `threshold_num_elements`: 2000（デフォルト）- context_length 8kモデルでの評価を確保するため、2000以下のグリッド要素を持つタスクに制限
- **パフォーマンスベースサンプリング**: 元のパフォーマンス分布を維持するためにタスクをサンプリング

#### **品質管理**
- **要素数フィルタリング**: 2000要素（入力+出力グリッド要素）を超えるタスクは、context_length 8kのモデルで評価が実行できるようにするために除外
- **バランスサンプリング**: 正解と不正解の例を元の精度率を維持するために比例的にサンプリング
- **重複防止**: サンプリングされたデータセット内でタスクの重複がないことを確保

#### **技術的実装**
- **スクリプト**: `scripts/data_uploader/upload_arc_agi.py`
- **サンプリングロジック**: 
  1. リファレンスモデルを使用してベースラインパフォーマンスを計算
  2. 複雑さの閾値でタスクをフィルタリング
  3. 正解/不正解の例を比例的にサンプリング
  4. タスクレベルのパフォーマンス分布を維持
- **出力**: ARC-AGIバージョンごとに50の代表的なタスクを含むキュレーションされたデータセット

---

## 3. データセット構造と形式

### 入力形式
各タスクは以下で構成されます：
- **トレーニング例**: パターンを実証する複数の入出力ペア
- **テスト入力**: モデルが正しい出力を生成する必要がある新しい入力

### 出力形式
モデルは2次元配列（List[List[int]]）として出力を生成する必要があります：
- 値は0-9の範囲（異なる色/パターンを表す）
- 配列は矩形である必要があります（すべての行が同じ長さ）
- 出力は期待される次元と値と完全に一致する必要があります

### タスク構造の例
```json
{
  "train": [
    {
      "input": [[1, 2, 3], [4, 5, 6]],
      "output": [[2, 3, 4], [5, 6, 7]]
    }
  ],
  "test": [
    {
      "input": [[7, 8, 9], [0, 1, 2]],
      "output": [[8, 9, 0], [1, 2, 3]]
    }
  ]
}
```

---

## 4. 評価プロセス

### 1. プロンプト生成
システムはトレーニング例とテスト入力を構造化されたプロンプトに変換します：
- トレーニング例は明確な入出力ペアでフォーマット
- テスト入力は別途提示
- 指示によりモデルがパターンを特定し出力を生成するようガイド

### 2. モデル推論
- モデルはプロンプトを処理し応答を生成
- 複数のリトライ試行を設定してパフォーマンスを向上
- エラーハンドリングはソフトとハードの両方の失敗モードをサポート

### 3. 出力解析
- **Backscan JSON Parser**: モデル出力から最後の有効なJSON配列を抽出
- **検証**: 出力が値0-9の有効な2次元配列であることを確保
- **形式チェック**: 矩形構造と適切な次元を検証

### 4. スコアリング
- **完全一致**: 出力は期待される結果と完全に一致する必要があります
- **タスク別スコアリング**: 各タスクはテスト例のパフォーマンスに基づいてスコアリング
- **最終スコア**: ARC-AGI-1とARC-AGI-2の両方の全タスクの平均

---

## 5. 設定オプション

### 基本設定
```yaml
arc_agi:
  num_attempts: 3                    # テスト例あたりのリトライ試行回数
  max_output_tokens: 1000           # モデル出力の最大トークン数
  error_handling:
    request_failure:
      mode: "soft"                  # "soft"または"hard"失敗処理
```

### エラーハンドリングモード
- **ソフトモード**: 一部のリクエストが失敗しても評価を継続
- **ハードモード**: 最初の失敗で評価を停止

### リトライ戦略
- **デフォルト試行回数**: テスト例あたり2回（公式ベンチマークと同じ）
- **成功基準**: 1回でも正解すればタスク成功とみなす

---

## 6. 可視化と分析

- 出力結果はWandb上に画像で可視化
- タイル画像を表示し、不一致のマスには推論結果とGround truthの色を示すBoundingBoxを表示
- 出力がJSONとしてパースできない場合、もしくは正しい2次元配列ではない場合は可視化されない

---

## 7. 補足・制限事項

- Reasoning modelの場合、ARC-AGIは非常にthinkin tokenが長くなる傾向があります。一部のAPIモデル(o3等)では結果が返ってこなくなる他、ローカルモデルでも正常処理できても10-30min程度かかるケースもあるため、timeoutを長めに設定してください

```
openai:
  http_timeout:
    connect: 10.0
    read: 2400.0
    write: 300.0
    pool: 30.0
```